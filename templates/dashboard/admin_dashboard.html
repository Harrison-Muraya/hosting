{% extends 'base.html' %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Admin Dashboard</h1>
    <p class="text-gray-600">System overview and management</p>
</div>

<!-- Stats Grid -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-blue-100 text-sm mb-1">Total Services</p>
                <p class="text-4xl font-bold">{{ total_services }}</p>
                <p class="text-blue-100 text-sm mt-2">{{ active_services }} active</p>
            </div>
            <i class="fas fa-server text-5xl opacity-30"></i>
        </div>
    </div>
    
    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-green-100 text-sm mb-1">Total Revenue</p>
                <p class="text-4xl font-bold">${{ total_revenue|floatformat:2 }}</p>
                <p class="text-green-100 text-sm mt-2">All time</p>
            </div>
            <i class="fas fa-dollar-sign text-5xl opacity-30"></i>
        </div>
    </div>
    
    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-orange-100 text-sm mb-1">Pending Invoices</p>
                <p class="text-4xl font-bold">{{ pending_invoices }}</p>
                <p class="text-orange-100 text-sm mt-2">Require attention</p>
            </div>
            <i class="fas fa-file-invoice text-5xl opacity-30"></i>
        </div>
    </div>
    
    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-purple-100 text-sm mb-1">Active Users</p>
                <p class="text-4xl font-bold">{{ active_users|default:"0" }}</p>
                <p class="text-purple-100 text-sm mt-2">Registered</p>
            </div>
            <i class="fas fa-users text-5xl opacity-30"></i>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-xl font-bold mb-4">Service Status Distribution</h3>
        <canvas id="serviceStatusChart"></canvas>
    </div>
    
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-xl font-bold mb-4">Revenue Trend (30 Days)</h3>
        <canvas id="revenueTrendChart"></canvas>
    </div>
</div>

<!-- Recent Services -->
<div class="bg-white rounded-lg shadow-lg mb-8">
    <div class="p-6 border-b border-gray-200">
        <h2 class="text-2xl font-bold">Recent Services</h2>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Plan</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">IP Address</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for service in recent_services %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-mono text-sm">#{{ service.id }}</td>
                    <td class="px-6 py-4">
                        <div>
                            <div class="font-medium">{{ service.user.username }}</div>
                            <div class="text-sm text-gray-500">{{ service.user.email }}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4">{{ service.plan.name }}</td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full text-sm font-medium
                            {% if service.status == 'active' %}bg-green-100 text-green-800
                            {% elif service.status == 'suspended' %}bg-red-100 text-red-800
                            {% elif service.status == 'pending' %}bg-yellow-100 text-yellow-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ service.status|upper }}
                        </span>
                    </td>
                    <td class="px-6 py-4 font-mono text-sm">{{ service.ip_address|default:"â€”" }}</td>
                    <td class="px-6 py-4 text-sm">{{ service.created_at|date:"Y-m-d H:i" }}</td>
                    <td class="px-6 py-4">
                        <div class="flex space-x-2">
                            <button class="text-blue-600 hover:text-blue-800" onclick="viewService({{ service.id }})" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="text-yellow-600 hover:text-yellow-800" onclick="editService({{ service.id }})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            {% if service.status == 'suspended' %}
                            <button class="text-green-600 hover:text-green-800" onclick="reactivateService({{ service.id }})" title="Reactivate">
                                <i class="fas fa-play-circle"></i>
                            </button>
                            {% endif %}
                            {% if service.status == 'active' %}
                            <button class="text-orange-600 hover:text-orange-800" onclick="suspendService({{ service.id }})" title="Suspend">
                                <i class="fas fa-pause-circle"></i>
                            </button>
                            {% endif %}
                            <button class="text-red-600 hover:text-red-800" onclick="terminateService({{ service.id }})" title="Terminate">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="px-6 py-8 text-center text-gray-500">No services yet</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Recent Transactions -->
<div class="bg-white rounded-lg shadow-lg">
    <div class="p-6 border-b border-gray-200">
        <h2 class="text-2xl font-bold">Recent Transactions</h2>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Transaction ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Method</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for transaction in recent_transactions %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-mono text-sm">{{ transaction.transaction_id }}</td>
                    <td class="px-6 py-4">{{ transaction.user.username }}</td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            {{ transaction.payment_method|upper }}
                        </span>
                    </td>
                    <td class="px-6 py-4 font-bold text-green-600">${{ transaction.amount }}</td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full text-sm font-medium
                            {% if transaction.status == 'completed' %}bg-green-100 text-green-800
                            {% elif transaction.status == 'failed' %}bg-red-100 text-red-800
                            {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                            {{ transaction.status|upper }}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm">{{ transaction.created_at|date:"Y-m-d H:i" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="px-6 py-8 text-center text-gray-500">No transactions yet</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
// Service Status Chart
const statusCtx = document.getElementById('serviceStatusChart').getContext('2d');
new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Active', 'Suspended', 'Pending', 'Terminated'],
        datasets: [{
            data: [{{ active_services }}, 10, 5, 3], // Replace with real data
            backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#6b7280']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true
    }
});

// Revenue Trend Chart
const revenueCtx = document.getElementById('revenueTrendChart').getContext('2d');
new Chart(revenueCtx, {
    type: 'line',
    data: {
        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
        datasets: [{
            label: 'Revenue ($)',
            data: [1200, 1900, 3000, 2500], // Replace with real data
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

function viewService(id) {
    window.location.href = `/api/services/${id}/`;
}

function editService(id) {
    alert('Edit service functionality - implement as needed');
}

function suspendService(id) {
    if (confirm('Are you sure you want to suspend this service?')) {
        fetch(`/api/admin/services/${id}/suspend/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            alert('Service suspended successfully');
            location.reload();
        })
        .catch(error => alert('Failed to suspend service'));
    }
}

function reactivateService(id) {
    if (confirm('Reactivate this service?')) {
        fetch(`/api/services/${id}/reactivate/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            alert('Service reactivated successfully');
            location.reload();
        })
        .catch(error => alert('Failed to reactivate service'));
    }
}

function terminateService(id) {
    if (confirm('WARNING: This will permanently delete the VM and all data. Are you sure?')) {
        if (confirm('This action cannot be undone. Continue?')) {
            fetch(`/api/admin/services/${id}/terminate/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                alert('Service terminated successfully');
                location.reload();
            })
            .catch(error => alert('Failed to terminate service'));
        }
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}